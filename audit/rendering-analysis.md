# 렌더링 품질 심층 분석

**감사자:** 미르 | **일자:** 2026-02-23

---

## 1. 현재 상태

### 시각 품질 테스트 결과 (comparison-v9)

| 등급 | 기준 | 문서 수 | 비율 |
|------|------|---------|------|
| A | SSIM ≥ 0.95 | 2 | 6.3% |
| B | SSIM ≥ 0.85 | 12 | 37.5% |
| C | SSIM ≥ 0.70 | 9 | 28.1% |
| D | SSIM ≥ 0.50 | 6 | 18.8% |
| F | SSIM < 0.50 | 3 | 9.4% |
| **통과 (A+B)** | | **14** | **43.8%** |

### 시간 경과에 따른 변화

| 시점 | 통과율 | 비고 |
|------|--------|------|
| comparison-v9 (최신) | 43.8% (14/32) | 32개 문서 |
| PROGRESS 2/23 보고 | 9.3% (4/43) | 43개 문서 세트 |

⚠️ **주의:** 두 테스트의 문서 세트가 다름 (32개 vs 43개). 직접 비교 어려움.

---

## 2. 실패 패턴 분석

### 패턴 1: 표(Table) 페이지 오버플로우 🔴 최다 빈도

**증상:** 원본 2페이지 → HanDoc 3~10페이지
**해당 문서:** [별표 6], [별지 2], 취약점_점검 시리즈
**근본 원인:**
- CSS 표 레이아웃과 한컴 표 레이아웃 엔진의 근본적 차이
- 한컴은 자체 레이아웃 엔진으로 셀 높이를 정밀 계산
- CSS는 브라우저 레이아웃 엔진에 위임 — 제어 한계

**시도한 조정들 (PROGRESS 로그 기반):**
1. page-break-inside: avoid → auto
2. line-height 1.6 → 1.5 → 1.4 → 1.2
3. cell padding 50% → 25% → 20%
4. letter-spacing -0.015em → revert
5. font-size 10pt → 9.5pt → revert

→ **파라미터 미세조정의 한계에 도달.** 한 문서를 개선하면 다른 문서가 깨지는 시소 효과.

### 패턴 2: 페이지 수 부족 (콘텐츠 압축)

**증상:** 원본 320페이지 → HanDoc 180페이지
**해당 문서:** 제안요청서_25년 홈택스 (F등급, SSIM 0.42)
**근본 원인:**
- 대량 표 문서에서 행 높이 과소 계산
- 빈 영역/여백 처리 미흡
- 페이지 브레이크 포인트 감지 부정확

### 패턴 3: 단일 페이지 시각 차이

**증상:** 페이지 수 동일하나 SSIM 0.64~0.83
**해당 문서:** [별표 2], [별표 4], [별지] 시리즈
**근본 원인:**
- 폰트 메트릭 차이 (한컴 고유 폰트 vs 대체 폰트)
- 표 테두리/셀 패딩 미세 차이
- 글자 간격(letter-spacing) 차이

---

## 3. PDF 렌더링 파이프라인 분석

```
DocumentModel
    ↓
html-renderer.ts (616줄) — 문서 → HTML 생성
    ↓
Puppeteer (headless Chrome) — HTML → PDF 렌더링
    ↓
PDF 출력
```

### 근본적 한계

**현재 방식:** DocumentModel → HTML → Puppeteer → PDF
**문제:** HTML/CSS 레이아웃 엔진(Blink)에 의존하므로 한컴 레이아웃과 **원리적으로 다른 결과**

**한컴오피스의 레이아웃:**
- 자체 텍스트 측정 (글꼴 메트릭 직접 계산)
- 자체 표 높이/너비 계산 알고리즘
- 자체 페이지 브레이크 알고리즘
- 1/7200인치 단위 정밀 배치 (HWPML unitID)

**HTML/CSS 레이아웃:**
- 브라우저 엔진에 위임
- 표는 CSS Table Layout Algorithm (auto/fixed)
- 페이지 브레이크는 CSS Paged Media (제한적)
- 폰트 메트릭은 OS/브라우저에 의존

→ **HTML 경유 방식으로는 SSIM 90%+ 달성에 구조적 한계가 있음**

### 대안: pdf-direct.ts (1,013줄)

pdf-lib를 직접 사용하는 경로도 존재. 이 방식이면:
- 글꼴 메트릭 직접 계산 가능
- 좌표 기반 정밀 배치 가능
- 한컴 레이아웃 엔진 모사 가능

**하지만:** 현재 pdf-direct.ts의 완성도/사용 현황 불명확

---

## 4. 경쟁 제품 벤치마크 (참고)

| 도구 | 방식 | 한글 지원 | 비고 |
|------|------|----------|------|
| LibreOffice | 자체 레이아웃 | 부분적 | HWP 미지원, HWPX 제한적 |
| 한컴 PDF 변환 | 네이티브 | 완벽 | 상용, API 없음 |
| hwp.js | JS 파서 | 읽기만 | 쓰기/PDF 없음 |
| **HanDoc** | HTML경유 + pdf-lib | 양방향 | 유일한 오픈소스 풀스택 |

→ HanDoc은 **경쟁자가 사실상 없는 블루오션**. 완벽하지 않아도 가치 있음.

---

## 5. 통과율 개선 로드맵 평가

### MJ의 PROGRESS 보고서 전략 평가

| 전략 | MJ 예측 | 미르 평가 |
|------|---------|----------|
| D→C 전환 (7개) | 1주, 25% | ✅ 현실적. 폰트/간격 미세조정으로 가능 |
| F등급 중 단순 문서 | 1개월, 5~10개 | ⚠️ 낙관적. 표 렌더링 근본 해결 없이는 2~3개 |
| 파서/레이아웃 재설계 | 3개월 | ✅ 필요하지만 ROI 재검토 필요 |

### 미르 권고: 전략 전환

**HTML 경유 PDF는 80% 통과율이 현실적 상한선.** 90%+ 달성하려면:

1. **pdf-direct 경로 강화** — pdf-lib로 좌표 기반 직접 렌더링
2. **또는 전략 전환** — PDF 렌더링 품질 대신 **파서/변환기 품질에 집중**

---

## 6. 종합 평가

| 항목 | 점수 | 설명 |
|------|------|------|
| 파싱 품질 | 10/10 | 570개 문서 100% 성공 |
| 라운드트립 | 10/10 | 완벽 보존 |
| PDF 단순 문서 | 7/10 | 단일 페이지 양식 문서는 양호 |
| PDF 복잡 문서 | 3/10 | 다중 표, 대량 문서에서 심각한 괴리 |
| 성능 | 8/10 | 단순 문서 0.2ms, 복잡 문서 64ms — 양호 |

**총평:** 파서로서는 세계 최고 수준. PDF 렌더링은 아키텍처 한계(HTML 경유)로 인해 구조적 천장이 있음. 제품 전략에서 PDF 품질의 중요도를 재정의할 필요 있음.
